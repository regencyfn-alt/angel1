<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Angel-1 ¬∑ Complete Faithful Geometry</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { 
  font-family: 'Segoe UI', system-ui, sans-serif; 
  background: #ffffff; 
  color: #333333;
  overflow-x: hidden;
}

#header {
  padding: 20px;
  background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
  border-bottom: 2px solid #cccccc;
}

#header h1 {
  font-size: 28px;
  font-weight: 300;
  letter-spacing: 3px;
  color: #e94560;
  margin-bottom: 10px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

#header .subtitle {
  font-size: 14px;
  color: #666666;
  letter-spacing: 1px;
}

#main {
  display: flex;
  gap: 20px;
  padding: 20px;
  min-height: calc(100vh - 200px);
  width: 100%;
}

#canvas-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #ffffff;
  padding: 20px;
  position: relative;
  min-width: 0;
}

#grid-scale-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f8f8;
  border-radius: 6px;
  align-items: center;
  border: 2px solid #e94560;
}

#grid-scale-controls button {
  padding: 8px 16px;
  background: linear-gradient(135deg, #e94560 0%, #d63552 100%);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
}

#grid-scale-controls button:hover {
  background: linear-gradient(135deg, #d63552 0%, #c72544 100%);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(233, 69, 96, 0.3);
}

#grid-scale-controls span {
  font-weight: 600;
  color: #e94560;
  font-size: 16px;
  min-width: 80px;
  text-align: center;
}

#zoom-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f8f8;
  border-radius: 6px;
  align-items: center;
  border: 2px solid #4a90e2;
}

#zoom-controls label {
  font-weight: 600;
  color: #4a90e2;
  font-size: 14px;
}

#zoom-controls input[type="range"] {
  flex: 1;
  min-width: 150px;
}

#zoom-controls span {
  font-weight: 600;
  color: #4a90e2;
  font-size: 14px;
  min-width: 50px;
}

#color-controls {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  padding: 12px;
  background: #f8f8f8;
  border-radius: 6px;
  flex-wrap: wrap;
  border: 2px solid #9b59b6;
}

.color-picker-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.color-picker-group label {
  font-size: 13px;
  font-weight: 600;
  color: #9b59b6;
}

.color-picker-group input[type="color"] {
  width: 50px;
  height: 30px;
  border: 2px solid #9b59b6;
  border-radius: 4px;
  cursor: pointer;
}

#column-controls {
  display: flex;
  gap: 4px;
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f8f8;
  border-radius: 6px;
  flex-wrap: wrap;
  width: 100%;
  justify-content: center;
}

.col-dropdown {
  padding: 4px 6px;
  font-size: 11px;
  border: 1px solid #cccccc;
  border-radius: 3px;
  background: white;
  cursor: pointer;
  transition: all 0.2s;
}

.col-dropdown:hover {
  border-color: #e94560;
  background: #fff5f7;
}

#svg-canvas {
  border: 2px solid #cccccc;
  border-radius: 8px;
  background: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

#sidebar {
  width: 320px;
  background: #f8f8f8;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}

.control-group {
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid #e0e0e0;
}

.control-group:last-child {
  border-bottom: none;
}

.control-group h3 {
  font-size: 14px;
  color: #e94560;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.metric-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding: 6px 10px;
  background: white;
  border-radius: 4px;
  font-size: 13px;
}

.metric-label {
  color: #666666;
  font-weight: 500;
}

.metric-value {
  color: #e94560;
  font-weight: 700;
}

.slider-group {
  margin-bottom: 15px;
}

.slider-group label {
  display: block;
  font-size: 12px;
  color: #666666;
  margin-bottom: 5px;
  font-weight: 600;
}

.slider-group input[type="range"] {
  width: 100%;
  margin-bottom: 5px;
}

.slider-group .slider-value {
  font-size: 11px;
  color: #999999;
  text-align: right;
}

button {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #e94560 0%, #d63552 100%);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 1px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(233, 69, 96, 0.2);
}

button:hover {
  background: linear-gradient(135deg, #d63552 0%, #c72544 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(233, 69, 96, 0.3);
}

button:active {
  transform: translateY(0);
}

.girth-group {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
  padding: 8px;
  background: white;
  border-radius: 4px;
}

.girth-group label {
  font-size: 12px;
  font-weight: 700;
  color: #e94560;
  min-width: 30px;
}

.girth-group input[type="range"] {
  flex: 1;
}

.girth-group span {
  font-size: 11px;
  color: #666666;
  min-width: 35px;
  text-align: right;
}
</style>
<script type='text/javascript' src='https://www.genspark.ai/S6ZZWwdJ8dNjLWxIAQEtdOP3_XMa6Z-prBMdzvyxtkgDc6HiGHesp35rinGsRmvmxvzyCTy61Ka73NiqRYgIPWcukAhSil9ObTFjzXtSkhHYz7LUBQlDM83GM5kQ8gMHOr7Qc-Cx5GMhk2Hcq9iKRPTOmMtgncdhJo3GTZj6Ihw='></script></head>
<body>

<div id="header">
  <h1>ANGEL-1</h1>
  <div class="subtitle">Complete Faithful Geometry ¬∑ Transactional Symmetry Simulator</div>
</div>

<div id="main">
  <div id="canvas-container">
    <div id="grid-scale-controls">
      <button onclick="removeColumn()">‚Üê Remove Column</button>
      <span id="col-count-display">Columns: 20</span>
      <button onclick="addColumn()">Add Column ‚Üí</button>
    </div>
    
    <div id="zoom-controls">
      <label>Zoom:</label>
      <input type="range" id="zoom-slider" min="20" max="80" value="40" step="5" oninput="updateZoom()">
      <span id="zoom-value">40px</span>
    </div>
    
    <div id="color-controls">
      <div class="color-picker-group">
        <label>Background:</label>
        <input type="color" id="color-bg" value="#ffffff" onchange="updateColors()">
      </div>
      <div class="color-picker-group">
        <label>Grid Lines:</label>
        <input type="color" id="color-grid" value="#cccccc" onchange="updateColors()">
      </div>
      <div class="color-picker-group">
        <label>Positive (+):</label>
        <input type="color" id="color-positive" value="#ffffff" onchange="updateColors()">
      </div>
      <div class="color-picker-group">
        <label>Negative (-):</label>
        <input type="color" id="color-negative" value="#000000" onchange="updateColors()">
      </div>
    </div>
    
    <div id="column-controls"></div>
    <svg id="svg-canvas"></svg>
  </div>

  <div id="sidebar">
    <div class="control-group">
      <h3>‚ö° Learning Control</h3>
      <button id="btn-reset" onclick="resetTrial()">Reset to Chaos</button>
      <button id="btn-pause" onclick="togglePause()" style="margin-top: 10px;">Pause</button>
    </div>

    <div class="control-group">
      <h3>üìä Harmony Metrics</h3>
      <div class="metric-row">
        <span class="metric-label">Harmony Score:</span>
        <span class="metric-value" id="harmony-score">0%</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Avg Oscillation:</span>
        <span class="metric-value" id="avg-oscillation">0¬∞</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Chirality Balance:</span>
        <span class="metric-value" id="chirality-balance">0</span>
      </div>
    </div>

    <div class="control-group">
      <h3>üîß Girth Controls (Washer Thickness)</h3>
      <div class="girth-group">
        <label>T3:</label>
        <input type="range" id="girth-t3" min="1" max="10" value="2" step="0.5" oninput="updateGirthDisplay()">
        <span id="girth-t3-val">2.0</span>
      </div>
      <div class="girth-group">
        <label>T2:</label>
        <input type="range" id="girth-t2" min="1" max="10" value="4" step="0.5" oninput="updateGirthDisplay()">
        <span id="girth-t2-val">4.0</span>
      </div>
      <div class="girth-group">
        <label>T1:</label>
        <input type="range" id="girth-t1" min="1" max="10" value="8" step="0.5" oninput="updateGirthDisplay()">
        <span id="girth-t1-val">8.0</span>
      </div>
    </div>

    <div class="control-group">
      <h3>‚öôÔ∏è Physics Parameters</h3>
      <div class="slider-group">
        <label>Alpha (Learning Rate):</label>
        <input type="range" id="alpha" min="0" max="1" step="0.01" value="0.3" oninput="updateSliderDisplay()">
        <div class="slider-value" id="alpha-val">0.30</div>
      </div>
      <div class="slider-group">
        <label>Beta (Mutation Rate):</label>
        <input type="range" id="beta" min="0" max="1" step="0.01" value="0.1" oninput="updateSliderDisplay()">
        <div class="slider-value" id="beta-val">0.10</div>
      </div>
      <div class="slider-group">
        <label>Delta-t (Time Step):</label>
        <input type="range" id="delta-t" min="0.1" max="2" step="0.1" value="1.0" oninput="updateSliderDisplay()">
        <div class="slider-value" id="delta-t-val">1.00</div>
      </div>
      <div class="slider-group">
        <label>Jitter (Randomness):</label>
        <input type="range" id="jitter" min="0" max="1" step="0.01" value="0.2" oninput="updateSliderDisplay()">
        <div class="slider-value" id="jitter-val">0.20</div>
      </div>
      <div class="slider-group">
        <label>Speed (Angular Velocity):</label>
        <input type="range" id="speed" min="0.5" max="5" step="0.5" value="3.0" oninput="updateSliderDisplay()">
        <div class="slider-value" id="speed-val">3.00</div>
      </div>
    </div>
  </div>
</div>

<script>
// === GRID CONFIG ===
let COLS = 20;
const ROWS = 9;
let SPACING = 40;

function getCanvasSize() {
  const WIDTH = COLS * SPACING;
  const HEIGHT = ROWS * SPACING;
  return { WIDTH, HEIGHT };
}

// === COLOR STATE ===
let COLORS = {
  bg: '#ffffff',
  grid: '#cccccc',
  positive: '#ffffff',
  negative: '#000000'
};

// === GLOBAL STATE ===
let chronons = [];
let isPaused = false;
let columnTypes = Array(COLS).fill('T1');

// === CHRONON CLASS (With Faithful Geometry) ===
class Chronon {
  constructor(col, row, subCol, subRow, type) {
    this.col = col;
    this.row = row;
    this.subCol = subCol;
    this.subRow = subRow;
    this.type = type;
    
    // Position calculation
    let boxSize;
    if (type === 'T1') boxSize = SPACING;
    else if (type === 'T2') boxSize = SPACING / 2;
    else if (type === 'T3') boxSize = SPACING / 3;
    
    this.x = col * SPACING + subCol * boxSize + boxSize/2;
    this.y = row * SPACING + subRow * boxSize + boxSize/2;
    
    // mC:rC ratio defines segmentation (FIXED GEOMETRY)
    // T3 = 2mC:1rC = 240¬∞ negative, 120¬∞ positive
    // T2 = 1mC:1rC = 180¬∞ negative, 180¬∞ positive
    // T1 = 1mC:2rC = 120¬∞ negative, 240¬∞ positive
    this.mCratio = type === 'T3' ? 2/3 : type === 'T2' ? 0.5 : 1/3;
    
    // Radius (girth affects this)
    const baseRadius = boxSize * 0.35;
    const girthMult = this.getGirthMultiplier();
    this.maxRadius = baseRadius * girthMult;
    this.minRadius = baseRadius * girthMult * 0.5; // At 90¬∞ contracts to 50%
    this.radius = this.maxRadius;
    
    // Arc position: 0¬∞ = center (touching neighbors), ¬±90¬∞ = extremes
    this.arcPos = Math.random() * 180 - 90; // Start random between -90 and +90
    
    // Chirality: +1 = right (expanding), -1 = left (contracting)
    this.chirality = Math.random() > 0.5 ? 1 : -1;
    
    // Rotation angle for visual segmentation
    this.rotationAngle = Math.random() * 360;
    
    // Collision flash
    this.collisionFlash = 0;
    
    // Neighbors
    this.neighbors = [];
  }
  
  getGirthMultiplier() {
    const t3Girth = parseFloat(document.getElementById('girth-t3').value);
    const t2Girth = parseFloat(document.getElementById('girth-t2').value);
    const t1Girth = parseFloat(document.getElementById('girth-t1').value);
    
    if (this.type === 'T3') return t3Girth / 2;
    if (this.type === 'T2') return t2Girth / 4;
    if (this.type === 'T1') return t1Girth / 8;
    return 1;
  }
  
  update() {
    // BOUNDED OSCILLATION: 0¬∞ ‚Üí ¬±90¬∞ ‚Üí back to 0¬∞
    // This is the GEOMETRIC INTERFERENCE model
    
    // Check if at center (0¬∞ position - maximum contact)
    const atCenter = Math.abs(this.arcPos) < 2;
    
    if (atCenter) {
      // AT CENTER: Check neighbors for chirality forcing
      const votes = this.checkNeighborChirality();
      
      // Neighbor majority FORCES chirality direction
      if (votes.right > votes.left) {
        if (this.chirality === -1) {
          this.chirality = 1;
          this.collisionFlash = 1.0;
        }
      } else if (votes.left > votes.right) {
        if (this.chirality === 1) {
          this.chirality = -1;
          this.collisionFlash = 1.0;
        }
      }
      // If equal votes (2/2), maintain current chirality
    }
    
    // Move based on chirality (oscillate toward extremes or back to center)
    let angularVelocity = parseFloat(document.getElementById('speed').value);
    
    // CONCRESENCE: All types reach 0¬∞ simultaneously
    // T3 moves slower, T1 moves faster
    if (this.type === 'T1') angularVelocity *= 1.0;
    else if (this.type === 'T2') angularVelocity *= 0.5;
    else if (this.type === 'T3') angularVelocity *= 0.25;
    
    // Move in current chirality direction
    this.arcPos += angularVelocity * this.chirality;
    
    // BOUNCE at ¬±90¬∞ (GEOMETRIC BOUND - physical interference prevents further rotation)
    if (Math.abs(this.arcPos) >= 90) {
      this.chirality *= -1; // Reverse direction (bounce back toward center)
      this.arcPos = Math.sign(this.arcPos) * 90; // Clamp to boundary
      this.collisionFlash = 1.0;
    }
    
    // Update radius based on arc position
    // At 0¬∞ = max radius (full contact with neighbors)
    // At ¬±90¬∞ = min radius (contracted away from neighbors)
    const oscillationFactor = Math.abs(this.arcPos) / 90; // 0 to 1
    this.radius = this.maxRadius - (this.maxRadius - this.minRadius) * oscillationFactor;
    
    // Visual rotation for segmented torus
    this.rotationAngle += angularVelocity * 0.5;
    
    // Decay collision flash
    if (this.collisionFlash > 0) {
      this.collisionFlash -= 0.1;
    }
  }
  
  checkNeighborChirality() {
    let leftCount = 0;
    let rightCount = 0;
    
    // Only count neighbors also near center (touching/contacting)
    this.neighbors.forEach(n => {
      if (Math.abs(n.arcPos) < 15) { // Within contact threshold
        if (n.chirality === 1) rightCount++;
        else leftCount++;
      }
    });
    
    return { left: leftCount, right: rightCount };
  }
  
  draw() {
    let elements = [];
    
    // Collision flash (yellow pulse when chirality forced)
    if (this.collisionFlash > 0) {
      const flash = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      flash.setAttribute('cx', this.x);
      flash.setAttribute('cy', this.y);
      flash.setAttribute('r', this.radius * 1.5);
      flash.setAttribute('fill', `rgba(255, 255, 0, ${this.collisionFlash * 0.5})`);
      flash.setAttribute('stroke', 'none');
      elements.push(flash);
    }
    
    // Draw segmented torus (showing mC:rC ratio)
    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    group.setAttribute('transform', `translate(${this.x}, ${this.y}) rotate(${this.rotationAngle})`);
    
    // Negative segment (mass - dark)
    const negAngle = this.mCratio * 360;
    const negPath = this.createArcPath(0, negAngle, this.radius);
    const negArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    negArc.setAttribute('d', negPath);
    negArc.setAttribute('fill', COLORS.negative);
    negArc.setAttribute('stroke', COLORS.grid);
    negArc.setAttribute('stroke-width', '1');
    group.appendChild(negArc);
    
    // Positive segment (radiance - light)
    const posAngle = (1 - this.mCratio) * 360;
    const posPath = this.createArcPath(negAngle, negAngle + posAngle, this.radius);
    const posArc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    posArc.setAttribute('d', posPath);
    posArc.setAttribute('fill', COLORS.positive);
    posArc.setAttribute('stroke', COLORS.grid);
    posArc.setAttribute('stroke-width', '1');
    group.appendChild(posArc);
    
    elements.push(group);
    
    return elements;
  }
  
  createArcPath(startAngle, endAngle, radius) {
    const start = this.polarToCartesian(0, 0, radius, endAngle);
    const end = this.polarToCartesian(0, 0, radius, startAngle);
    const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
    
    return [
      "M", start.x, start.y,
      "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y,
      "L", 0, 0,
      "Z"
    ].join(" ");
  }
  
  polarToCartesian(centerX, centerY, radius, angleInDegrees) {
    const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
    return {
      x: centerX + (radius * Math.cos(angleInRadians)),
      y: centerY + (radius * Math.sin(angleInRadians))
    };
  }
}

// === INITIALIZATION ===
function init() {
  chronons = [];
  
  for (let col = 0; col < COLS; col++) {
    const type = columnTypes[col];
    
    for (let row = 0; row < ROWS; row++) {
      if (type === 'T1') {
        chronons.push(new Chronon(col, row, 0, 0, 'T1'));
      } else if (type === 'T2') {
        for (let sc = 0; sc < 2; sc++) {
          for (let sr = 0; sr < 2; sr++) {
            chronons.push(new Chronon(col, row, sc, sr, 'T2'));
          }
        }
      } else if (type === 'T3') {
        for (let sc = 0; sc < 3; sc++) {
          for (let sr = 0; sr < 3; sr++) {
            chronons.push(new Chronon(col, row, sc, sr, 'T3'));
          }
        }
      }
    }
  }
  
  // Link neighbors
  chronons.forEach(c => {
    c.neighbors = chronons.filter(n => {
      if (n === c) return false;
      const dx = Math.abs(n.col - c.col);
      const dy = Math.abs(n.row - c.row);
      return (dx <= 1 && dy <= 1);
    });
  });
  
  renderColumnControls();
  draw();
}

// === MAIN LOOP ===
function animate() {
  if (!isPaused) {
    chronons.forEach(c => c.update());
    draw();
    updateMetrics();
  }
  requestAnimationFrame(animate);
}

// === DRAWING ===
function draw() {
  const svg = document.getElementById('svg-canvas');
  const { WIDTH, HEIGHT } = getCanvasSize();
  
  svg.setAttribute('width', WIDTH);
  svg.setAttribute('height', HEIGHT);
  svg.innerHTML = '';
  svg.style.background = COLORS.bg;
  
  // Draw grid
  for (let col = 0; col <= COLS; col++) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', col * SPACING);
    line.setAttribute('y1', 0);
    line.setAttribute('x2', col * SPACING);
    line.setAttribute('y2', HEIGHT);
    line.setAttribute('stroke', COLORS.grid);
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);
  }
  
  for (let row = 0; row <= ROWS; row++) {
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', 0);
    line.setAttribute('y1', row * SPACING);
    line.setAttribute('x2', WIDTH);
    line.setAttribute('y2', row * SPACING);
    line.setAttribute('stroke', COLORS.grid);
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);
  }
  
  // Draw chronons
  chronons.forEach(c => {
    const elements = c.draw();
    elements.forEach(el => svg.appendChild(el));
  });
}

// === COLUMN CONTROLS ===
function renderColumnControls() {
  const container = document.getElementById('column-controls');
  container.innerHTML = '';
  
  for (let col = 0; col < COLS; col++) {
    const select = document.createElement('select');
    select.className = 'col-dropdown';
    select.innerHTML = `
      <option value="T1" ${columnTypes[col] === 'T1' ? 'selected' : ''}>T1</option>
      <option value="T2" ${columnTypes[col] === 'T2' ? 'selected' : ''}>T2</option>
      <option value="T3" ${columnTypes[col] === 'T3' ? 'selected' : ''}>T3</option>
    `;
    select.onchange = (e) => {
      columnTypes[col] = e.target.value;
      init();
    };
    container.appendChild(select);
  }
  
  document.getElementById('col-count-display').textContent = `Columns: ${COLS}`;
}

function addColumn() {
  COLS++;
  columnTypes.push('T1');
  init();
}

function removeColumn() {
  if (COLS > 4) {
    COLS--;
    columnTypes.pop();
    init();
  }
}

// === ZOOM CONTROL ===
function updateZoom() {
  const slider = document.getElementById('zoom-slider');
  SPACING = parseInt(slider.value);
  document.getElementById('zoom-value').textContent = `${SPACING}px`;
  
  // Recalculate all chronon positions
  chronons.forEach(c => {
    let boxSize;
    if (c.type === 'T1') boxSize = SPACING;
    else if (c.type === 'T2') boxSize = SPACING / 2;
    else if (c.type === 'T3') boxSize = SPACING / 3;
    
    c.x = c.col * SPACING + c.subCol * boxSize + boxSize/2;
    c.y = c.row * SPACING + c.subRow * boxSize + boxSize/2;
    
    const baseRadius = boxSize * 0.35;
    const girthMult = c.getGirthMultiplier();
    c.maxRadius = baseRadius * girthMult;
    c.minRadius = baseRadius * girthMult * 0.5;
  });
  
  draw();
}

// === COLOR CONTROLS ===
function updateColors() {
  COLORS.bg = document.getElementById('color-bg').value;
  COLORS.grid = document.getElementById('color-grid').value;
  COLORS.positive = document.getElementById('color-positive').value;
  COLORS.negative = document.getElementById('color-negative').value;
  draw();
}

// === METRICS ===
function updateMetrics() {
  let totalOscillation = 0;
  let harmonyPairs = 0;
  let totalPairs = 0;
  let rightChiral = 0;
  let leftChiral = 0;
  
  chronons.forEach(c => {
    totalOscillation += Math.abs(c.arcPos);
    if (c.chirality === 1) rightChiral++;
    else leftChiral++;
    
    // Count harmony (opposite chirality neighbors in contact)
    c.neighbors.forEach(n => {
      if (Math.abs(c.arcPos) < 15 && Math.abs(n.arcPos) < 15) {
        totalPairs++;
        if (c.chirality !== n.chirality) {
          harmonyPairs++;
        }
      }
    });
  });
  
  const avgOsc = (totalOscillation / chronons.length).toFixed(1);
  const harmonyScore = totalPairs > 0 ? ((harmonyPairs / totalPairs) * 100).toFixed(1) : 0;
  const chiralityBalance = rightChiral - leftChiral;
  
  document.getElementById('harmony-score').textContent = `${harmonyScore}%`;
  document.getElementById('avg-oscillation').textContent = `${avgOsc}¬∞`;
  document.getElementById('chirality-balance').textContent = chiralityBalance;
}

// === UI UPDATES ===
function updateSliderDisplay() {
  document.getElementById('alpha-val').textContent = parseFloat(document.getElementById('alpha').value).toFixed(2);
  document.getElementById('beta-val').textContent = parseFloat(document.getElementById('beta').value).toFixed(2);
  document.getElementById('delta-t-val').textContent = parseFloat(document.getElementById('delta-t').value).toFixed(2);
  document.getElementById('jitter-val').textContent = parseFloat(document.getElementById('jitter').value).toFixed(2);
  document.getElementById('speed-val').textContent = parseFloat(document.getElementById('speed').value).toFixed(2);
}

function updateGirthDisplay() {
  document.getElementById('girth-t3-val').textContent = parseFloat(document.getElementById('girth-t3').value).toFixed(1);
  document.getElementById('girth-t2-val').textContent = parseFloat(document.getElementById('girth-t2').value).toFixed(1);
  document.getElementById('girth-t1-val').textContent = parseFloat(document.getElementById('girth-t1').value).toFixed(1);
  
  // Update all chronon radii
  chronons.forEach(c => {
    let boxSize;
    if (c.type === 'T1') boxSize = SPACING;
    else if (c.type === 'T2') boxSize = SPACING / 2;
    else if (c.type === 'T3') boxSize = SPACING / 3;
    
    const baseRadius = boxSize * 0.35;
    const girthMult = c.getGirthMultiplier();
    c.maxRadius = baseRadius * girthMult;
    c.minRadius = baseRadius * girthMult * 0.5;
  });
  
  draw();
}

function resetTrial() {
  init();
}

function togglePause() {
  isPaused = !isPaused;
  document.getElementById('btn-pause').textContent = isPaused ? 'Resume' : 'Pause';
}

// === START ===
init();
animate();
updateSliderDisplay();
updateGirthDisplay();
</script>

</body>
</html>
